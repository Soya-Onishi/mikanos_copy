# マルチタスク(1)

## コンテキストの切り替えに挑戦

### メモ

#### 初期状態での各レジスタの値について

`rsp`（スタックポインタレジスタ）はx86-64アーキテクチャによるアライメント制約のため
`rsp`の下位4ビットが8になってないといけない。
そのための式が`(<stack最後尾の値> & ~0xFlu) - 8`。

`fxsave_area`のオフセット24byte〜27byteはMXCSRレジスタに対応する。
`MXCSR`レジスタは浮動小数点の状態を管理するためのレジスタ。
`MXCSR`レジスタ内のビット12:7をすべて`1`にしないといけない。
`0x1F80`を代入することで上記ビット範囲を`1`にできる。

```
|15|14|13|12|11|10| 9| 8| 7| 6| 5| 4| 3| 2| 1| 0|
| 0| 0| 0| 1| 1| 1| 1| 1| 1| 0| 0| 0| 0| 0| 0| 0|
|    0x1    |    0xF    |    0x8    |    0x0    |
```

#### コンテキスト切替時の次のコンテキストにおける一部レジスタの値について

一部レジスタ（`SS`, `CS`,  `RSP`, `RFLAGS`, `RIP`）は
`iret`命令を用いることで同時に値を格納させることができる。
上記操作はあらかじめスタックに指定された順序で格納しておくことで実施できる。