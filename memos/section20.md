# システムコール

## メモ

### 無限ループは未定義動作

C++11では無限ループは未定義動作とのこと。
（本来は仕様書を読んで本当に未定義動作になっているのかを調べる必要はある）

Cでは未定義動作ではないらしい。

### `o64 retq`について

実際には64ビット向け`RETF`命令になるらしい（オペコード 0x48 0xCB）
far returnと呼ばれるもので、これを使うことでスタックに入っている値が
CSなどに書き込まれる。

異なる特権レベルの間を行き来する際、レベル高からレベル低に遷移する場合は
SSやRSPもスタックを利用して値がコピーされる（みかん本）
intelのドキュメントには特にレベル高からなどの記載はないものの、
低から高は`far call`、高から低は`far ret`と記載している雰囲気がある。
ちなみに`far call`のさいは`SS`と`RSP`はスタックからではなく
`TSS`とよばれる別の構造体から値を参照して格納される。

### TSSについて

割り込みなどによってRing3からRing0に入るときに
Ring0時に使用するスタックポインタの値などが入っている。
タイマ割り込み発生時などに自動的に予め設定していた値が
`RSP`レジスタなどに格納される。

`TSS`はメモリ上に存在し、TSSを指定するためにディスクリプタを使用する(`System Segment Descriptor`)。
`CS`や`SS`で使用するディスクリプタと異なり、2つのディスクリプタで指定する。
1つ目のディスクリプタは`CS`などのディスクリプタの形式と大差ないものの、
2つ目のディスクリプタは0-31bitを`TSS`を指すアドレスの上位32ビットの格納のために使用するのみで、
32-63bitは予約済みの状態である。

### Ring3からRing0ジャンプ時のスタックの破壊について